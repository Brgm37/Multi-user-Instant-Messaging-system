


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > MessageServices</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">services</a>
</div>

<h1>Coverage Summary for Class: MessageServices (services)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">MessageServices</td>
<td class="coverageStat">
  <span class="percent">
    80%
  </span>
  <span class="absValue">
    (4/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (1/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    85.7%
  </span>
  <span class="absValue">
    (6/7)
  </span>
</td>
</tr>
  <tr>
    <td class="name">MessageServices$createMessage$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    45%
  </span>
  <span class="absValue">
    (9/20)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    89.5%
  </span>
  <span class="absValue">
    (17/19)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MessageServices$deleteMessage$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MessageServices$getMessage$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (2/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    83.3%
  </span>
  <span class="absValue">
    (5/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MessageServices$latestMessages$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (3/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (5/5)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    77.8%
  </span>
  <span class="absValue">
    (7/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    34.1%
  </span>
  <span class="absValue">
    (15/44)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    71.7%
  </span>
  <span class="absValue">
    (33/46)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package services
&nbsp;
&nbsp;import TransactionManager
&nbsp;import errors.MessageError
&nbsp;import interfaces.MessageServicesInterface
&nbsp;import jakarta.inject.Named
&nbsp;import model.channels.AccessControl
&nbsp;import model.channels.Channel
&nbsp;import model.channels.ChannelInfo
&nbsp;import model.messages.Message
&nbsp;import model.users.UserInfo
&nbsp;import utils.Either
&nbsp;import utils.failure
&nbsp;import utils.success
&nbsp;
<b class="fc">&nbsp;@Named(&quot;MessageServices&quot;)</b>
&nbsp;class MessageServices(
<b class="fc">&nbsp;    private val repoManager: TransactionManager,</b>
&nbsp;) : MessageServicesInterface {
&nbsp;    override fun createMessage(
&nbsp;        msg: String,
&nbsp;        user: UInt,
&nbsp;        channel: UInt,
&nbsp;    ): Either&lt;MessageError, Message&gt; {
<b class="pc">&nbsp;        if (msg.isEmpty()) return failure(MessageError.InvalidMessageInfo)</b>
<b class="fc">&nbsp;        return repoManager.run {</b>
<b class="pc">&nbsp;            val msgChannel = channelRepo.findById(channel) ?: return@run failure(MessageError.ChannelNotFound)</b>
<b class="pc">&nbsp;            val channelId = checkNotNull(msgChannel.cId) { &quot;Channel id is null&quot; }</b>
<b class="pc">&nbsp;            val msgUser = userRepo.findById(user) ?: return@run failure(MessageError.UserNotFound)</b>
<b class="pc">&nbsp;            val uId = checkNotNull(msgUser.uId) { &quot;User id is null&quot; }</b>
<b class="fc">&nbsp;            val message =</b>
<b class="fc">&nbsp;                Message(</b>
<b class="fc">&nbsp;                    msg = msg,</b>
<b class="fc">&nbsp;                    user = UserInfo(uId, msgUser.username),</b>
<b class="fc">&nbsp;                    channel = ChannelInfo(channelId, msgChannel.name),</b>
&nbsp;                )
<b class="fc">&nbsp;            val userAccessControl =</b>
<b class="pc">&nbsp;                channelRepo.findUserAccessControl(channelId, uId) ?: return@run failure(MessageError.UserNotInChannel)</b>
<b class="pc">&nbsp;            if (msgChannel is Channel.Public &amp;&amp;</b>
<b class="pc">&nbsp;                msgChannel.accessControl == AccessControl.READ_ONLY &amp;&amp;</b>
<b class="nc">&nbsp;                msgChannel.owner.uId != uId</b>
&nbsp;            ) {
<b class="nc">&nbsp;                return@run failure(MessageError.UserDoesNotHaveAccess)</b>
&nbsp;            }
<b class="pc">&nbsp;            if (userAccessControl == AccessControl.READ_ONLY) return@run failure(MessageError.UserDoesNotHaveAccess)</b>
<b class="fc">&nbsp;            val createdMessage = messageRepo.createMessage(message)</b>
<b class="pc">&nbsp;            checkNotNull(createdMessage) { &quot;Message is null&quot; }</b>
<b class="fc">&nbsp;            success(createdMessage)</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    override fun deleteMessage(
&nbsp;        msgId: UInt,
&nbsp;        uId: UInt,
&nbsp;    ): Either&lt;MessageError, Unit&gt; =
<b class="nc">&nbsp;        repoManager.run {</b>
<b class="nc">&nbsp;            val message = messageRepo.findById(msgId) ?: return@run failure(MessageError.MessageNotFound)</b>
<b class="nc">&nbsp;            val channel =</b>
<b class="nc">&nbsp;                channelRepo.findById(message.channel.cId) ?: return@run failure(MessageError.ChannelNotFound)</b>
<b class="nc">&nbsp;            val channelId = checkNotNull(channel.cId) { &quot;Channel id is null&quot; }</b>
<b class="nc">&nbsp;            if (!channelRepo.isUserInChannel(channelId, uId)) return@run failure(MessageError.UserNotInChannel)</b>
<b class="nc">&nbsp;            if (message.user.uId != uId &amp;&amp; channel.owner.uId != uId) {</b>
<b class="nc">&nbsp;                return@run failure(MessageError.UserDoesNotHaveAccess)</b>
&nbsp;            }
<b class="nc">&nbsp;            messageRepo.deleteById(msgId)</b>
<b class="nc">&nbsp;            success(Unit)</b>
&nbsp;        }
&nbsp;
&nbsp;    override fun getMessage(
&nbsp;        msgId: UInt,
&nbsp;        uId: UInt,
&nbsp;    ): Either&lt;MessageError, Message&gt; =
<b class="fc">&nbsp;        repoManager.run {</b>
<b class="pc">&nbsp;            val message = messageRepo.findById(msgId) ?: return@run failure(MessageError.MessageNotFound)</b>
<b class="pc">&nbsp;            if (!channelRepo.isUserInChannel(</b>
<b class="fc">&nbsp;                    message.channel.cId,</b>
<b class="fc">&nbsp;                    uId,</b>
&nbsp;                )
&nbsp;            ) {
<b class="nc">&nbsp;                return@run failure(MessageError.UserNotInChannel)</b>
&nbsp;            }
<b class="fc">&nbsp;            success(message)</b>
&nbsp;        }
&nbsp;
&nbsp;    override fun latestMessages(
&nbsp;        channelId: UInt,
&nbsp;        uId: UInt,
&nbsp;        offset: UInt,
&nbsp;        limit: UInt,
&nbsp;    ): Either&lt;MessageError, List&lt;Message&gt;&gt; {
<b class="fc">&nbsp;        return repoManager.run {</b>
<b class="pc">&nbsp;            val channel = channelRepo.findById(channelId) ?: return@run failure(MessageError.ChannelNotFound)</b>
<b class="pc">&nbsp;            val chId = checkNotNull(channel.cId) { &quot;Channel id is null&quot; }</b>
<b class="pc">&nbsp;            if (!channelRepo.isUserInChannel(chId, uId)) return@run failure(MessageError.UserNotInChannel)</b>
<b class="fc">&nbsp;            val messages = messageRepo.findMessagesByChannelId(chId, limit, offset)</b>
<b class="fc">&nbsp;            success(messages)</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-10-21 22:04</div>
</div>
</body>
</html>
